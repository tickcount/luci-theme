# CLAUDE.md

## Project Overview

Outline Theme — a modern OpenWrt LuCI theme built with Vite and Tailwind CSS v4. Licensed under Apache 2.0.

Target: OpenWrt 23.05+ routers. The theme replaces the default LuCI web interface appearance.

## Tech Stack

- **Tailwind CSS v4** — utility-first CSS with oklch color system
- **Vite 7** — build tool and dev server with custom plugins
- **pnpm** — package manager (managed via Corepack, pinned in `package.json`)
- **Terser** — JS minification (no bundling, just compression)
- **lightningcss** — CSS minification
- **Prettier** + `prettier-plugin-tailwindcss` — code formatting
- **ucode** — OpenWrt template language (`.ut` files)

## Directory Structure

```
.dev/                          # Development environment (frontend toolchain)
  src/media/main.css           # CSS entry point (Tailwind CSS)
  src/resource/                # JavaScript source files
    menu-outline.js             # Menu configuration
    view/outline/sysauth.js     # Login page view
  src/assets/icons/            # SVG icons
  public/outline/               # Static assets (fonts, images)
  scripts/clean.js             # Build cleanup utility
  vite.config.ts               # Vite config with custom plugins
  package.json                 # Node.js deps and scripts
  .prettierrc                  # Prettier config
  .env.example                 # Environment template
htdocs/luci-static/            # Build output (committed, auto-generated by CI)
  outline/main.css              # Compiled CSS
  resources/                   # Minified JS modules
ucode/template/themes/outline/  # LuCI ucode templates (.ut files)
  header.ut                    # Page header template
  footer.ut                    # Page footer template
  sysauth.ut                   # Login page template
root/etc/uci-defaults/         # OpenWrt system integration scripts
Makefile                       # OpenWrt package Makefile
```

## Development Commands

All commands run from the `.dev/` directory:

```bash
pnpm install          # Install dependencies
pnpm dev              # Start dev server (proxies to OpenWrt router)
pnpm build            # Production build → htdocs/luci-static/
pnpm clean            # Clean build output
```

### Environment Setup

Copy `.dev/.env.example` to `.dev/.env` and set `VITE_OPENWRT_HOST` to your router's address (e.g., `http://192.168.1.1`).

## Build Pipeline

1. Vite builds CSS entry (`src/media/main.css`) with Tailwind CSS
2. PostCSS plugin removes `@layer` at-rules (OpenWrt compatibility)
3. CSS minified via lightningcss
4. Custom `luci-js-compress` Vite plugin minifies JS via Terser (compress/mangle disabled, comments stripped)
5. Static assets copied from `.dev/public/outline/`
6. Output lands in `htdocs/luci-static/`

## CI/CD Workflows

- **build-and-commit.yml** — On push to `master` (when `.dev/` sources change), auto-builds and commits `htdocs/` output. Commit messages prefixed with `build:` are skipped to avoid loops.
- **pr-check.yml** — On PRs to `master`/`main`, runs Prettier check and build verification.
- **build-and-release-outline.yml** — On `v*` tags or manual trigger, compiles OpenWrt `.ipk`/`.apk` packages via the `eamonxg/build-luci-package` action.

## Router & Template Deployment

The development router is at `10.0.1.1` (hostname `outline.lan`), accessible via SSH as `root`.

### Ucode Templates (`.ut` files)

Ucode is OpenWrt's template language. Templates live on the router at:
```
/usr/share/ucode/luci/template/themes/outline/
  header.ut      # Main page layout (nav, body wrapper, alerts)
  footer.ut      # Page footer
  sysauth.ut     # Login page
```

Templates are **compiled and cached** by uhttpd on first request. After any `.ut` change, uhttpd must be restarted to flush the cache.

### Deploying Templates

CSS changes are live-reloaded via Vite dev server. Template changes require pushing files to the router:

```bash
# Upload templates via sftp (scp also works)
sftp root@10.0.1.1 <<'SFTP'
put ucode/template/themes/outline/header.ut /usr/share/ucode/luci/template/themes/outline/header.ut
put ucode/template/themes/outline/sysauth.ut /usr/share/ucode/luci/template/themes/outline/sysauth.ut
SFTP

# Restart uhttpd to flush template cache
# IMPORTANT: Use MSYS_NO_PATHCONV=1 on Windows (Git Bash) to prevent
# /etc/init.d path from being mangled by MSYS path conversion
MSYS_NO_PATHCONV=1 ssh root@10.0.1.1 "/etc/init.d/uhttpd restart"
```

### Windows (Git Bash / MSYS2) Caveats

- **Path conversion**: MSYS auto-converts Unix paths in SSH commands (e.g., `/etc/init.d/uhttpd` becomes `C:/Program Files/Git/etc/init.d/uhttpd`). Always prefix SSH commands with `MSYS_NO_PATHCONV=1`.
- **sftp vs scp**: Both work for file uploads. Use `sftp` with heredoc for multiple files.
- **SSH host key**: If the router is reflashed, remove the old key with `ssh-keygen -R 10.0.1.1` and reconnect with `-o StrictHostKeyChecking=accept-new`.

## Key Conventions

- **CSS**: Uses Tailwind CSS v4 with oklch colors. Dark mode via `@custom-variant dark (&:where([data-darkmode=true], ...))`; not `prefers-color-scheme`. CSS nesting is supported via lightningcss.
- **JS files are NOT bundled** — they're individually minified and placed at the same relative paths under `resources/`.
- **`htdocs/` is auto-generated** — don't manually edit files there. Edit sources in `.dev/src/` and run `pnpm build`.
- **Template changes** (`.ut` files) have no hot reload — deploy to router and restart uhttpd (see above).
- **Formatting**: Prettier with tailwindcss plugin. Format-on-save configured in `.vscode/settings.json`.
- **Commit style**: Use conventional commits. Build commits use `build:` prefix. Release commits use `chore(release):` prefix. Bug fixes use `fix(scope):`.

## Important Notes

- This is a **theme for OpenWrt LuCI** — the web interface for OpenWrt routers. All pages are server-rendered by LuCI using ucode templates, with client-side JS for interactivity.
- The Vite dev server proxies requests to an actual OpenWrt router. A real device on the same network is needed for development.
- The `@layer` removal PostCSS plugin is critical — OpenWrt's LuCI doesn't support CSS layers.
- Package version is tracked in `Makefile` (`PKG_VERSION` and `PKG_RELEASE`), not `package.json`.
- Browser targets: Chrome 111+, Safari 16.4+, Firefox 128+.
